<g transform="{{`translate(${x} ${y}) ${rotate}`}}">
  <rect width="{{w}}" height="{{w}}"
        x="{{0}}" y="{{0}}"
        style="fill:{{interpolateViridis(lvl/maxlvl)}}" />
  {{#if w >= 1}}
  <:Self w="{{nextLeft}}"
              x="{{0}}" y="{{-nextLeft}}"
              lvl="{{lvl + 1}}" maxlvl="{{maxlvl}}"
              heightFactor="{{heightFactor}}"
              lean="{{lean}}"
              left />

  <:Self w="{{nextRight}}"
              x="{{w - nextRight}}" y="{{-nextRight}}"
              lvl="{{lvl + 1}}" maxlvl="{{maxlvl}}"
              heightFactor="{{heightFactor}}"
              lean="{{lean}}"
              right />
  {{/if}}
</g>

<script>
import { interpolateViridis } from 'd3-scale'

Math.deg = radians => {
  return radians * (180 / Math.PI)
}

export default {
  namespace: 'svg',

  data() {
    return {
      heightFactor: 0,
      lean: 0,
      left: 0,
      lvl: 0,
      maxlvl: 0,
      right: 0,
      w: 0
    }
  },

  computed: {

    trigH: (heightFactor, w) => heightFactor * w,

    rotate: (left, right, A, B, w) => {
      if (left) {
        return `rotate(${-A} 0 ${w})`
      } else if (right) {
        return `rotate(${B} ${w} ${w})`
      } else {
        return 'rotate(0)'
      }
    },

    nextLeft: (w, trigH, lean) => Math.sqrt(trigH ** 2 + (w * (0.5 - lean)) ** 2),

    nextRight: (w, trigH, lean) => Math.sqrt(trigH ** 2 + (w * (0.5 + lean)) ** 2),

    A: (w, trigH, lean) => Math.deg(Math.atan(trigH / ((0.5 - lean) * w))),

    B: (w, trigH, lean) => Math.deg(Math.atan(trigH / ((0.5 + lean) * w))),
  },

  helpers: {
    interpolateViridis: interpolateViridis
  }
}
</script>
