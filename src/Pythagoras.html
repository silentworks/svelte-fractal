<g transform="{{`translate(${x} ${y}) ${rotate}`}}">
  <rect width="{{w}}" height="{{w}}"
        x="{{0}}" y="{{0}}"
        style="fill:{{interpolateViridis(lvl/maxlvl)}}" />

  {{#if w >= 1}}
  <:Self w="{{nextLeft}}"
              x="{{0}}" y="{{-nextLeft}}"
              lvl="{{lvl + 1}}" maxlvl="{{maxlvl}}"
              heightFactor="{{heightFactor}}"
              lean="{{lean}}"
              left />

  <:Self w="{{nextRight}}"
              x="{{w - nextRight}}" y="{{-nextRight}}"
              lvl="{{lvl + 1}}" maxlvl="{{maxlvl}}"
              heightFactor="{{heightFactor}}"
              lean="{{lean}}"
              right />
  {{/if}}
</g>

<script>
import { interpolateViridis } from 'd3-scale'

Math.deg = radians => {
  return radians * (180 / Math.PI)
}

const memo = {}

const key = ({ w, heightFactor, lean }) => {
  return [w, heightFactor, lean].join('-')
}

const memoizedCalc = args => {
  const memoKey = key(args)

  if (memo[memoKey]) {
    return memo[memoKey]
  } else {
    const { w, heightFactor, lean } = args
    const trigH = heightFactor * w

    const result = {
      nextRight: Math.sqrt(trigH ** 2 + (w * (0.5 + lean)) ** 2),
      nextLeft: Math.sqrt(trigH ** 2 + (w * (0.5 - lean)) ** 2),
      A: Math.deg(Math.atan(trigH / ((0.5 - lean) * w))),
      B: Math.deg(Math.atan(trigH / ((0.5 + lean) * w)))
    }

    memo[memoKey] = result
    return result
  }
}

export default {
  namespace: 'svg',

  data() {
    return {
      heightFactor: 0,
      lean: 0,
      left: 0,
      lvl: 0,
      maxlvl: 0,
      right: 0,
      w: 0
    }
  },

  computed: {
    rotate: (left, right, A, B, w) => {
      let rotate = 'rotate(0)'

      if (left) {
        rotate = `rotate(${-A} 0 ${w})`
      } else if (right) {
        rotate = `rotate(${B} ${w} ${w})`
      }

      return rotate
    },

    nextLeft: (w, heightFactor, lean) => {
      const { nextLeft } = memoizedCalc({
        w,
        heightFactor,
        lean
      })
      return nextLeft
    },

    nextRight: (w, heightFactor, lean) => {
      const { nextRight } = memoizedCalc({
        w,
        heightFactor,
        lean
      })
      return nextRight
    },

    A: (w, heightFactor, lean) => {
      const { A } = memoizedCalc({
        w,
        heightFactor,
        lean
      })
      return A
    },

    B: (w, heightFactor, lean) => {
      const { B } = memoizedCalc({
        w,
        heightFactor,
        lean
      })
      return B
    }
  },

  helpers: {
    interpolateViridis: interpolateViridis
  }
}
</script>
