<div class="App">
  <div className="App-header">
      <h2>This is a dancing Pythagoras tree</h2>
  </div>
  <p class="App-intro">
    <svg width="{{svg.width}}" height="{{svg.height}}" ref:svg>
        <Pythagoras w="{{baseW}}"
                    h="{{baseW}}"
                    heightFactor="{{heightFactor}}"
                    lean="{{lean}}"
                    x="{{svg.width / 2 - 40}}"
                    y="{{svg.height - baseW}}"
                    lvl="{{0}}"
                    maxlvl="{{currentMax}}"/>
    </svg>
  </p>
</div>

<script>
import { select as d3select, mouse as d3mouse } from 'd3-selection'
import { scaleLinear } from 'd3-scale'
import Pythagoras from './Pythagoras.html'

function throttleWithRAF (fn) {
  let running = false
  return function () {
    if (running) return
    running = true
    window.requestAnimationFrame(() => {
      fn.apply(this, arguments)
      running = false
    })
  }
}

const realMax = 11

export default {
  components: { Pythagoras },

  data () {
    return {
      svg: {
        width: 1280,
        height: 600
      },

      currentMax: 0,
      baseW: 80,
      heightFactor: 0,
      lean: 0
    }
  },

  oncreate () {
    this.container = this.refs.svg
    d3select(this.container).on('mousemove', this.onMouseMove.bind(this))
    this.next()
  },

  methods: {
    next () {
      let currentMax = this.get('currentMax');
      if (currentMax < realMax) {
        currentMax += 1
        this.set({currentMax});
        setTimeout(this.next.bind(this), 500)
      }
    },

    onMouseMove () {
      const [x, y] = d3mouse(this.container)
      this.update(x, y)
    },

    update: throttleWithRAF(function (x, y) {
      const svg = this.get('svg');
      const scaleFactor = scaleLinear()
        .domain([svg.height, 0])
        .range([0, 0.8])

      const scaleLean = scaleLinear()
        .domain([0, svg.width / 2, svg.width])
        .range([0.5, 0, -0.5])

      this.set({
        heightFactor: scaleFactor(y),
        lean: scaleLean(x)
      })
    })
  }
}
</script>

<style>
.App {
  text-align: center;
}

.App-logo {
  height: 80px;
}

.App-header {
  background-color: #222;
  height: 150px;
  padding: 20px;
  color: white;
}

.App-intro {
  font-size: large;
}

@keyframes App-logo-spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
</style>
